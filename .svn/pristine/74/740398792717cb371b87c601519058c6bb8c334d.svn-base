"use strict";function reConnect(n){var t=function(n,i){$("#connState").text("正在重新连接……");n.start().then(function(){$("#connState").text("已连接");console.log("连接成功")}).catch(function(r){console.log(r);i<5?($("#connState").text("连接失败，稍后重试……"),setTimeout(t,5e3,n,++i)):$("#connState").text("连接失败，已重试"+i+"次，点击上线按钮重新连接")})};t(n,1)}function chatContentResize(n){n.css("display","inline");n.parent().css("width","auto");$(".chat-board").width()*.75>n.width()&&n.parent().width(n.width()+15);n.css("display","block")}function chatBoardResize(){var i=$(".body-content"),r=$(window).height()-20,n,t;i.css("height",r);n=0;t=$(".chat-board");t.parent().prevAll().each(function(){n+=$(this).outerHeight()});t.css("height",i.height()-n-70)}function isAtBottom(n){var t=n[0],i=t.scrollTop,r=t.scrollHeight,u=t.clientHeight;return i+u>=r?!0:!1}function scrollToBottom(n){var t=n[0],i=t.scrollTop,r=t.clientHeight;n.animate({scrollTop:i+r},500)}$(document).ready(function(){function t(t){var i=document.getElementById("messageInput").value;/^\s*$/.test(i)||(n.invoke("SendMessage",i).then(function(){$("#messageInput").val("")}).catch(function(n){return console.log(n.toString())}),t.preventDefault())}var n=(new window.signalR.HubConnectionBuilder).withUrl("/chatHub").build();n.on("ReceiveMessage",function(n,t){var i,r,u;i=n===$("#user").val()?$("#messageBubbleTemplate .chat-self").eq(0).clone():$("#messageBubbleTemplate .chat-other").eq(0).clone();$(".name",i).text(n);$(".logo img",i).attr("src","/images/userLogo/"+n+".png");$(".content",i).text(t);r=$(".chat-board");u=isAtBottom(r);r.append(i);chatContentResize($(".content",i));u&&scrollToBottom(r)});n.on("ReceiveOnlineNotice",function(n){var i=$("#messageBubbleTemplate .chat-notice").eq(0).clone(),t,r;$("span",i).text("用户 "+n+" 上线");t=$(".chat-board");r=isAtBottom(t);t.append(i);chatContentResize($(".content",i));r&&scrollToBottom(t)});n.on("ReceiveOfflineNotice",function(n){var i=$("#messageBubbleTemplate .chat-notice").eq(0).clone(),t,r;$("span",i).text("用户 "+n+" 下线");t=$(".chat-board");r=isAtBottom(t);t.append(i);chatContentResize($(".content",i));r&&scrollToBottom(t)});n.on("ReceiveClearChatBoardCommand",function(n){var t,i,r;$(".chat-board").empty();t=$("#messageBubbleTemplate .chat-notice").eq(0).clone();$("span",t).text("用户 "+n+" 清空了所有人的聊天版");i=$(".chat-board");r=isAtBottom(i);i.append(t);chatContentResize($(".content",t));r&&scrollToBottom(i)});$("#connState").text("正在连接……");n.start().then(function(){$("#connState").text("已连接");console.log("连接成功")}).catch(function(t){$("#connState").text("连接失败，稍后重试……");console.log(t);setTimeout(function(){reConnect(n)},5e3)});n.onclose(function(t){$("#connState").text("连接已关闭");console.log("连接已关闭");t&&($("#connState").text("发生错误，连接已关闭，稍后重试……"),console.log(t),setTimeout(function(){reConnect(n)},5e3))});document.getElementById("send").addEventListener("click",t);$("#offline").click(function(){n.connection.connectionState!==2&&n.stop()});$("#online").click(function(){n.connection.connectionState===2&&reConnect(n)});$("#clearChatBoard").click(function(){$.ajax({url:"/SignalR/Chat/Index?handler=ClearOnlineUsersChatBoard",error:function(){alert("清空失败")}})});$(document).keypress(function(n){n.ctrlKey&&n.keyCode===10&&t(n)});$(window).resize(chatBoardResize);$(".chat-board").resize(function(){var n=$(".chat-self .content, .chat-other .content");n.each(function(){chatContentResize($(this))})});chatBoardResize()});